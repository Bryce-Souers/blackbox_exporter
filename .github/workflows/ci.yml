---
name: CI
on:
  - push
  - pull_request
jobs:
  #test:
  #  strategy:
  #    matrix:
  #      os:
  #        - ubuntu-latest
  #        - windows-latest
  #        - macos-latest
  #  runs-on: ${{ matrix.os }}
  #  steps:
  #    - uses: actions/checkout@v4.2.2
  #    - uses: actions/setup-go@v5.2.0
  #      with:
  #        go-version: 1.23
  #    - run: make build
  #    - run: make test GOOPTS=-v

  build_all:
    name: Build for all architectures
    strategy:
      matrix:
        thread: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Import PromCI
        uses: prometheus/promci@v0.4.5

      - name: Cross-build
        uses: ./.github/promci/actions/build
        with:
          thread: ${{ matrix.thread }}
          parallelism: 12
          promu_opts: -p linux

  publish_master:
    name: Publish master
    if: github.event_name == 'push' && github.event.ref == 'refs/heads/master'
    needs:
      - build_all
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Import PromCI
        uses: prometheus/promci@v0.4.5

      - name: Publish
        uses: ./.github/promci/actions/publish_main
        with:
          docker_hub_organization: brycesouers
          docker_hub_login: ${{ secrets.docker_hub_login }}
          docker_hub_password: ${{ secrets.docker_hub_password }}
